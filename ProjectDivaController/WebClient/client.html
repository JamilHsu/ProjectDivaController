<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<style>
html, body {
    margin:0;
    padding:0;
    width:100%;
    height:100%;
    background:#000;
    overflow:hidden;
    touch-action:none;
    font-family:sans-serif;

    -webkit-user-select:none;
    -ms-user-select:none;
    user-select:none;

    -webkit-touch-callout:none;
    user-touch-callout:none;

    -webkit-user-drag:none;
    user-drag:none;
}

#startBtn {
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#222;
    color:#fff;
    font-size:2em;
    cursor:pointer;
    user-select:none;
}

#area {
    width:100%;
    height:100%;
    display:flex;
    flex-direction:column;
    opacity:0;
    pointer-events:none;
}

/* 上方黃色區塊 */
#topBar {
    background:#FFFF00;
}

/* 下方按鈕區域 */
#buttonsArea {
    flex:1;
    display:flex;
}

.section {
    flex:1;
    position:relative;
}

#sec1 { background:#00DDAA; }
#sec2 { background:#FF66DD; }
#sec3 { background:#44AAFF; }
#sec4 { background:#FF2277; }

.section img {
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    object-fit:contain;
    pointer-events:none;
}
</style>
</head>
<body>

<div id="startBtn">Touch to Start</div>

<div id="area">
    <div id="topBar"></div>
    <div id="buttonsArea">
        <div id="sec1" class="section"><img src="/image/button1.png"></div>
        <div id="sec2" class="section"><img src="/image/button2.png"></div>
        <div id="sec3" class="section"><img src="/image/button3.png"></div>
        <div id="sec4" class="section"><img src="/image/button4.png"></div>
    </div>
</div>

<script>
document.addEventListener("contextmenu", e => e.preventDefault());

/* ---------------- WebSocket ---------------- */
const ws = new WebSocket("ws://" + location.host + "/ws");
function wsSend(s) {
    if (ws.readyState === 1) ws.send(s);
}
ws.onmessage = ev => {
    let s = ev.data;
    if (s.length >= 2) s = s[0] + 'O' + s.slice(2);
    ws.send(s);
};

/* ---------------- 全螢幕 + 開始 ---------------- */
const startBtn = document.getElementById("startBtn");
const area     = document.getElementById("area");

const lastPos  = new Map();

async function enterFullscreen() {
    const d = document.documentElement;
    try {
        if (!document.fullscreenElement) {
            if (d.requestFullscreen) await d.requestFullscreen();
            else if (d.webkitRequestFullscreen) await d.webkitRequestFullscreen();
        }
    } catch(e){}
}

function showTouchArea() {
    startBtn.style.display = "none";
    area.style.opacity = "1";
    area.style.pointerEvents = "auto";
    sendScreenInfo();
}

startBtn.addEventListener("click", async () => {
    await enterFullscreen();
    showTouchArea();
});

/* ---------------- 螢幕尺寸傳送 ---------------- */
const slider_height = 25;
function sendScreenInfo() {
    const topBar = document.getElementById("topBar");
    topBar.style.height = slider_height + "%";

    const dpr = window.devicePixelRatio || 1;
    let w, h;

    if (window.visualViewport) {
        w = Math.round(window.visualViewport.width  * dpr);
        h = Math.round(window.visualViewport.height * dpr);
    } else {
        w = Math.round(window.innerWidth  * dpr);
        h = Math.round(window.innerHeight * dpr);
    }

    const manu  = navigator.vendor || "";
    const model = navigator.userAgent || "";

    wsSend(`SCREENSIZE: ${w} ${h} ${slider_height} ${manu} ${model}\n`);
}

window.addEventListener("resize", sendScreenInfo);
if (window.visualViewport) {
    window.visualViewport.addEventListener("resize", sendScreenInfo);
}

/* ---------------- Pixel conversion ---------------- */
const dpr = window.devicePixelRatio || 1;
function toPx(x, y) {
    return [(x * dpr) | 0, (y * dpr) | 0];
}

/* ---------------- Touch handling ---------------- */

area.addEventListener("touchstart", e => {
    e.preventDefault();
    for (const t of e.changedTouches) {
        const [px, py] = toPx(t.clientX, t.clientY);
        lastPos.set(t.identifier, px);
        wsSend(`D ${t.identifier} ${px} ${py}\n`);
    }
}, { passive: false });

area.addEventListener("touchmove", e => {
    e.preventDefault();
    let msg = "";
    let changed = false;

    for (const t of e.changedTouches) {
        const [px, py] = toPx(t.clientX, t.clientY);

        if (lastPos.get(t.identifier) !== px) {
            lastPos.set(t.identifier, px);
            msg += ` ${t.identifier} ${px} ${py}`;
            changed = true;
        }
    }

    if (changed) wsSend("M" + msg + "\n");
}, { passive: false });

area.addEventListener("touchend", e => {
    e.preventDefault();
    for (const t of e.changedTouches) {
        lastPos.delete(t.identifier);
        const [px, py] = toPx(t.clientX, t.clientY);
        wsSend(`U ${t.identifier} ${px} ${py}\n`);
    }
}, { passive: false });

area.addEventListener("touchcancel", e => {
    e.preventDefault();
    lastPos.clear();
    wsSend("C\n");
}, { passive: false });
</script>
</body>
</html>
